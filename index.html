<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Room Drive</title>
    <style> body { margin: 0; overflow: hidden; } </style>
</head>
<body>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let player = null; // 操作キャラ（缶）
        const keys = {};  

        // 1. シーン設定
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333); // 部屋がない場所は暗く

        // 2. カメラ
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5); 

        // 3. レンダラー
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        // 部屋のライト（少し明るめにする）
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0; 
        document.body.appendChild(renderer.domElement);

        // 4. ライト（室内用に調整）
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); // 全体を明るく
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        scene.add(dirLight);

        const loader = new GLTFLoader();

        // --- 5. 【ステージ】部屋の読み込み ---
        // ★ここにスキャンした部屋のファイル名を入れてください
        loader.load('models/Love_inn.glb', (gltf) => {
            const room = gltf.scene;
            scene.add(room);
            
            // 部屋は影を受ける側
            room.traverse((n) => { 
                if(n.isMesh) {
                    n.receiveShadow = true; 
                    n.castShadow = true; // 家具の影も落とす
                }
            });

            // 位置調整（必要なら）
            room.position.y = 0; 
            // サイズ調整（Scaniverseは実寸なので1倍でOKだが、大きすぎたら調整）
            room.scale.set(1, 1, 1); 

        }, undefined, (e) => console.error('部屋エラー:', e));


        // --- 6. 【プレイヤー】モンスターエナジーの読み込み ---
        loader.load('models/MONSTER_ENERGIE.glb', (gltf) => { 
            player = gltf.scene; 
            scene.add(player);
            player.traverse((n) => { if(n.isMesh) n.castShadow = true; });

            // サイズ調整（部屋の中で違和感ないサイズに）
            // 部屋がリアルサイズ(m)なら、缶は0.3mくらい？
            // 小さすぎると見えないので、あえて少し大きく「1メートル」くらいにします
            const box = new THREE.Box3().setFromObject(player);
            const size = box.getSize(new THREE.Vector3());
            const scale = 1.0 / size.y; // 高さ1mにする
            player.scale.set(scale, scale, scale);

            // 初期位置（少し浮かす）
            player.position.set(0, 0.5, 0);

        }, undefined, (e) => console.error('プレイヤーエラー:', e));

        // キー操作
        document.addEventListener('keydown', (e) => keys[e.key] = true);
        document.addEventListener('keyup', (e) => keys[e.key] = false);

        // 7. アニメーション
        function animate() {
            requestAnimationFrame(animate);

            if (player) {
                const moveSpeed = 0.1; // 室内なので少しゆっくりに
                const rotateSpeed = 0.05;

                if (keys['a'] || keys['A']) player.rotation.y += rotateSpeed; 
                if (keys['d'] || keys['D']) player.rotation.y -= rotateSpeed; 

                if (keys['w'] || keys['W']) {
                    player.position.x -= Math.sin(player.rotation.y) * moveSpeed;
                    player.position.z -= Math.cos(player.rotation.y) * moveSpeed;
                }
                if (keys['s'] || keys['S']) {
                    player.position.x += Math.sin(player.rotation.y) * moveSpeed;
                    player.position.z += Math.cos(player.rotation.y) * moveSpeed;
                }

                // カメラ追従（距離を近めに設定）
                const offset = new THREE.Vector3(0, 2, 4); // 高さ2m, 後ろ4m
                offset.applyQuaternion(player.quaternion);
                offset.add(player.position);
                camera.position.lerp(offset, 0.1);
                camera.lookAt(player.position.x, player.position.y + 1, player.position.z);
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
