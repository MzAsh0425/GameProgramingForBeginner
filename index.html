<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Kobito Room Explorer</title>
    <style> body { margin: 0; overflow: hidden; } </style>
</head>
<body>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        let player = null; 
        let room = null;
        const keys = {};  

        // 1. シーン設定
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); // 部屋の外は真っ暗闇

        // 2. カメラ（初期位置）
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 100);
        
        // 3. レンダラー
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2; // 室内なので少し明るく
        document.body.appendChild(renderer.domElement);

        // 4. ライト
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        // プレイヤーの真上に追従するライト（懐中電灯代わり）
        const spotLight = new THREE.SpotLight(0xffffff, 1);
        spotLight.angle = Math.PI / 4;
        spotLight.penumbra = 0.5;
        spotLight.castShadow = true;
        scene.add(spotLight);

        const loader = new GLTFLoader();

        // --- 5. 部屋の読み込み ---
        loader.load('models/Love_inn.glb', (gltf) => {
            room = gltf.scene;
            scene.add(room);
            room.traverse((n) => { 
                if(n.isMesh) {
                    n.receiveShadow = true; 
                    n.castShadow = true;
                    // ※天井が見えるように「裏面も描画」する設定
                    if(n.material) n.material.side = THREE.DoubleSide;
                }
            });

            // ★重要★ ここで部屋の高さを調整します
            // ScaniverseのデータはY=0が「物体の中心」になりがちなので、床を下げる必要があります。
            // 実際に動かしてみて、この数値を書き換えるか、キーボードの↑↓で調整してください。
            room.position.y = -1.5; // とりあえず1.5メートル下げてみる

        }, undefined, (e) => console.error(e));

        // --- 6. プレイヤー（缶）の読み込み ---
        loader.load('models/MONSTER_ENERGIE.glb', (gltf) => { 
            player = gltf.scene; 
            scene.add(player);
            player.traverse((n) => { if(n.isMesh) n.castShadow = true; });

            // ★小人化サイズ★
            // 缶の高さをリアルな「15cm (0.15)」に設定
            const box = new THREE.Box3().setFromObject(player);
            const size = box.getSize(new THREE.Vector3());
            const scale = 0.15 / size.y; 
            player.scale.set(scale, scale, scale);

            player.position.set(0, 0.1, 0); // 地面から少しだけ浮かせる

        }, undefined, (e) => console.error(e));

        document.addEventListener('keydown', (e) => keys[e.key] = true);
        document.addEventListener('keyup', (e) => keys[e.key] = false);

        // 7. アニメーション
        function animate() {
            requestAnimationFrame(animate);

            // 部屋の高さ調整機能（↑↓キーで床の高さを変える）
            // これで「天井めり込み」を解消してください！
            if (room) {
                if (keys['ArrowUp'])   room.position.y -= 0.05; // 部屋を下げる（相対的に自分が上がる）
                if (keys['ArrowDown']) room.position.y += 0.05; // 部屋を上げる
            }

            if (player) {
                // 小人なので移動スピードは遅く
                const moveSpeed = 0.03; 
                const rotateSpeed = 0.04;

                if (keys['a'] || keys['A']) player.rotation.y += rotateSpeed; 
                if (keys['d'] || keys['D']) player.rotation.y -= rotateSpeed; 

                if (keys['w'] || keys['W']) {
                    player.position.x -= Math.sin(player.rotation.y) * moveSpeed;
                    player.position.z -= Math.cos(player.rotation.y) * moveSpeed;
                }
                if (keys['s'] || keys['S']) {
                    player.position.x += Math.sin(player.rotation.y) * moveSpeed;
                    player.position.z += Math.cos(player.rotation.y) * moveSpeed;
                }

                // ライトをプレイヤーに追従させる
                spotLight.position.set(player.position.x, player.position.y + 2, player.position.z);
                spotLight.target = player;

                // --- 究極の「小人視点」カメラ ---
                // 缶の真後ろ、すぐ近くにカメラを置く
                // 高さ: 0.2m (地面スレスレ), 後ろ: 0.4m
                const offset = new THREE.Vector3(0, 0.2, 0.4); 
                offset.applyQuaternion(player.quaternion);
                offset.add(player.position);
                
                // カメラの動きをキビキビさせる（Lerp係数を大きく0.2へ）
                camera.position.lerp(offset, 0.2);
                
                // プレイヤーの少し前方を見る
                const lookAtPos = new THREE.Vector3(0, 0.1, -1); // 缶の正面方向
                lookAtPos.applyQuaternion(player.quaternion);
                lookAtPos.add(player.position);
                camera.lookAt(lookAtPos);
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
